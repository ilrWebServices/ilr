<?php

/**
 * @file
 * Contains ilr.module.
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\ilr\FieldStorageDefinition;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\Core\Field\FieldDefinition;
use Drupal\Core\Render\BubbleableMetadata;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\Core\Field\Entity\BaseFieldOverride;
use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Field\WidgetBase;

/**
 * Implements hook_theme().
 */
function ilr_theme($existing, $type, $theme, $path) {
  return [
    'ilr_certificate_basics_block' => [
      'variables' => [
        'node' => [],
      ],
    ],
    'ilr_class_register_block' => [
      'variables' => [
        'classes' => [],
      ],
    ],
    'ilr_course_certificates_block' => [
      'variables' => [
        'node' => [],
        'certificates' => [],
      ],
    ],
    'ilr_course_page_nav_block' => [
      'variables' => [
        'node' => [],
        'links' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_entity_field_storage_info().
 */
function ilr_entity_field_storage_info(EntityTypeInterface $entity_type) {
  $definitions = [];

  if ($entity_type->id() == 'node') {
    $definitions['classes'] = FieldStorageDefinition::create('entity_reference')
      ->setName('classes')
      ->setLabel(t('Classes'))
      ->setRevisionable(FALSE)
      ->setCustomStorage(TRUE)
      ->setTargetEntityTypeId($entity_type->id());
    $definitions['certificates'] = FieldStorageDefinition::create('entity_reference')
      ->setName('certificates')
      ->setLabel(t('Certificates'))
      ->setRevisionable(FALSE)
      ->setCustomStorage(TRUE)
      ->setTargetEntityTypeId($entity_type->id());
    $definitions['sessions'] = FieldStorageDefinition::create('entity_reference')
      ->setName('sessions')
      ->setLabel(t('Sessions'))
      ->setRevisionable(FALSE)
      ->setCustomStorage(TRUE)
      ->setCardinality(FieldStorageDefinitionInterface::CARDINALITY_UNLIMITED)
      ->setTargetEntityTypeId($entity_type->id())
      ->setSetting('target_type', 'class_session');
  }

  return $definitions;
}

/**
 * Implements hook_entity_bundle_field_info().
 *
 * - Add computed fields to course nodes.
 * - Refine the settings for the collection_item `item` field:
 *   - Allow `media` and `taxonomy_term` entities.
 *   - Restrict the bundles for all allowed entities.
 *   - @todo: Allow these settings to be configured per collection_item bundle
 *     via the UI.
 *  - Add computed fields to class nodes.
 */
function ilr_entity_bundle_field_info(EntityTypeInterface $entity_type, $bundle, array $base_field_definitions) {
  $fields = [];

  if ($entity_type->id() == 'node' && $bundle == 'course') {
    $custom_field_storage = ilr_entity_field_storage_info($entity_type);

    $fields[$custom_field_storage['classes']->getName()] = FieldDefinition::createFromFieldStorageDefinition($custom_field_storage['classes']);

    $fields[$custom_field_storage['classes']->getName()]
      ->setLabel(t('Classes'))
      ->setComputed(TRUE)
      ->setClass('\Drupal\ilr\CourseClassItemList')
      ->setSettings([
        'handler' => 'default:node',
        'handler_settings' => [
          'target_bundles' => [
            'class' => 'class'
          ]
        ],
      ])
      ->setDisplayConfigurable('view', TRUE)
      ->setDisplayOptions('view', [
        'label' => 'hidden',
        'weight' => -5,
      ]);

    $fields[$custom_field_storage['certificates']->getName()] = FieldDefinition::createFromFieldStorageDefinition($custom_field_storage['certificates']);

    $fields[$custom_field_storage['certificates']->getName()]
      ->setLabel(t('Certificates'))
      ->setComputed(TRUE)
      ->setClass('\Drupal\ilr\CourseCertificateItemList')
      ->setSettings([
        'handler' => 'default:node',
        'handler_settings' => [
          'target_bundles' => [
            'certificate' => 'certificate'
          ]
        ],
      ])
      ->setDisplayConfigurable('view', FALSE);
  }

  if ($entity_type->id() == 'node' && $bundle == 'class') {
    $custom_field_storage = ilr_entity_field_storage_info($entity_type);

    $fields[$custom_field_storage['sessions']->getName()] = FieldDefinition::createFromFieldStorageDefinition($custom_field_storage['sessions']);

    $fields[$custom_field_storage['sessions']->getName()]
      ->setLabel(t('Sessions'))
      ->setComputed(TRUE)
      ->setClass('\Drupal\ilr\ClassSessionItemList')
      ->setSettings([
        'handler' => 'default:class_session',
        'handler_settings' => [
          'target_bundles' => NULL,
        ],
      ]);
  }

  // Update all collection_item bundles to use updated field settings.
  // @todo Move this to the collection module and configure each bundle dynamically.
  if ($entity_type->id() === 'collection_item') {
    $fields['item'] = BaseFieldOverride::createFromBaseFieldDefinition($base_field_definitions['item'], $bundle);
    $entity_type_ids_setting = $fields['item']->getSetting('entity_type_ids');
    $fields['item']
      ->setSetting('entity_type_ids', $entity_type_ids_setting + [
        'media' => 'media',
        'persona' => 'persona',
        'taxonomy_term' => 'taxonomy_term',
      ])
      ->setSetting('media', [
        'handler' => 'default:media',
        'handler_settings' => [
          'target_bundles' => [
            'image' => 'image',
            'remote_video' => 'remote_video',
          ]
        ]
      ])
      ->setSetting('node', [
        'handler' => 'default:node',
        'handler_settings' => [
          'target_bundles' => [
            'certificate' => 'certificate',
            'course' => 'course',
            'page' => 'page',
            'post' => 'post',
          ]
        ]
      ])
      ->setSetting('persona', [
        'handler' => 'default:persona',
        'handler_settings' => [
          'target_bundles' => [
            'author' => 'author',
            'faculty' => 'faculty',
            'staff' => 'staff',
          ]
        ]
      ])
      ->setSetting('taxonomy_term', [
        'handler' => 'default:taxonomy_term',
        'handler_settings' => [
          'target_bundles' => [
            'topics' => 'topics',
          ]
        ]
      ]);
  }

  return $fields;
}

/**
 * Implements hook_entity_extra_field_info().
 */
function ilr_entity_extra_field_info() {
  $extra = [];

  // Add a pseudo-field that can display the computed certificates field on this
  // course node. This will be exposed as a field block to layout builder.
  $extra['node']['course']['display']['ilr_certificates'] = [
    'label' => t('Certificates (computed)'),
    'description' => t('This is a computed backreference to certificates.'),
    'weight' => 0,
    'visible' => TRUE,
  ];

  // Add a pseudo-field that can display the course page links.
  $extra['node']['course']['display']['ilr_course_page_links'] = [
    'label' => t('Course Page Links (extra)'),
    'description' => t('A list of course page links.'),
    'weight' => 0,
    'visible' => TRUE,
  ];

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function ilr_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  if ($display->getComponent('ilr_certificates') && $view_mode === 'full') {
    $build['ilr_certificates'] = [
      '#theme' => 'ilr_course_certificates_block',
      '#node' => $entity,
      '#certificates' => $entity->certificates->referencedEntities(),
    ];
  }

  if ($display->getComponent('ilr_course_page_links') && $view_mode === 'full') {
    $page_links = [
      [
        'url' => '#course-details',
        'text' => 'Course Details',
      ],
      [
        'url' => '#instructors',
        'text' => 'The Instructors',
      ],
      [
        'url' => '#related-courses',
        'text' => 'Related Courses',
      ],
      [
        'url' => '/programs/professional-programs/registration-information',
        'text' => 'Registration Information',
      ]
    ];

    if ($entity->classes->count() === 0) {
      // Remove the instructors link when there are no classes.
      unset($page_links[1]);
    }

    $build['ilr_course_page_links'] = [
      '#theme' => 'ilr_course_page_nav_block',
      '#node' => $entity,
      '#links' => $page_links,
    ];
  }
}

/**
 * Implements hook_entity_prepare_view().
 */
function ilr_entity_prepare_view($entity_type_id, array $entities, array $displays, $view_mode) {
  if (empty($entities)) {
    return;
  }

  // Use a default value for course `field_message` if empty. This means that
  // courses can either use the default message as defined in the custom block
  // _or_ override that value. They cannot disable the message completely.
  if ($entity_type_id === 'node') {
    foreach ($entities as $node) {
      if ($node->bundle() === 'course' && $node->field_message->isEmpty()) {
        $default_message_block = \Drupal::service('entity.repository')->loadEntityByUuid('block_content', '280c1d2d-0456-45eb-84dc-d114c5e7b2fa');

        if ($default_message_block) {
          $node->field_message->value = $default_message_block->body->value;
          $node->field_message->format = $default_message_block->body->format;
        }
      }
    }
  }

  if ($entity_type_id === 'paragraph') {
    foreach ($entities as $paragraph) {
      $paragraph->include_button = TRUE; // You can do this!?
      $paragraph->cu_icon = [];

      // Use data values from existing content (if specified) in promos.
      if ($paragraph->bundle() === 'promo' && !$paragraph->field_content->isEmpty()) {
        $content = $paragraph->field_content->entity;

        if ($content->getEntityTypeId() === 'persona') {
          $heading = $content->getDisplayName();
          $body = $content->field_bio->summary;
          $media = $content->hasField('field_photo') ? $content->field_photo : NULL;
          $paragraph->cu_icon = [
            'title' => 'Persona',
            'label' => 'Spotlight',
            'icon' => 'student',
            'attributes' => ['class' => 'cu-icon--color-light'],
          ];
        }
        else {
          $heading = $content->label();
          $body = $content->body->summary;
          $media = $content->hasField('field_representative_image') ? $content->field_representative_image : NULL;
        }

        if ($paragraph->field_heading->isEmpty()) {
          $paragraph->field_heading->value = $heading;
        }

        if ($paragraph->field_body->isEmpty()) {
          $paragraph->field_body->value = $body;
        }

        if ($paragraph->field_media->isEmpty() && !$media->isEmpty()) {
          $paragraph->field_media->target_id = $media->target_id;
        }

        if ($paragraph->field_link->isEmpty()) {
          $paragraph->field_link = [
            'uri' => 'entity:' . $content->toUrl()->getInternalPath(),
            'title' => t('Read more about') . ' ' . $paragraph->field_heading->value,
          ];
          $paragraph->include_button = FALSE;
        }
      }

      if ($paragraph->bundle() === 'promo' && !$paragraph->field_media->isEmpty() && !$paragraph->field_suppress_media->isEmpty() && $paragraph->field_suppress_media->value) {
        $paragraph->field_media->removeItem(0);
      }
    }
  }
}

/**
 * Implements hook_query_TAG_alter().
 *
 * De-dupe post listing queries during the same request.
 *
 * NOTE: This will alter the SelectQuery that is compiled from the EntityQuery
 * in  \Drupal\ilr\Plugin\paragraphs\Behavior\PostListing::preprocess(). There
 * is a contrib module that allows the altering of EntityQuery:
 * https://www.drupal.org/project/entity_query_alter.
 */
function ilr_query_post_listing_alter(Drupal\Core\Database\Query\AlterableInterface $query) {
  if ($query->hasTag('post_listing_clone')) {
    return;
  }

  // Find the 'dedupe_group' for this post listing. All post listings in the
  // same group are de-duped. `alterTags` is a protected property in QueryBase,
  // but it seems we can access it here anyway. Which is lucky for us!
  foreach (array_keys($query->alterTags) as $tag) {
    if (strpos($tag, 'dedupe__') === 0) {
      $dedupe_group = $tag;
    }
  }

  if (empty($dedupe_group)) {
    return;
  }

  // Fetch previously returned collection item ids.
  $cached_collection_item_ids = &drupal_static(__FUNCTION__ . '_' . $dedupe_group, []);

  // Add a condition to filter out previously returned collection item ids.
  // Since this is a SelectQuery transformed from and EntityQuery, we can't use
  // a condition field name like `id` as we would in the original query in
  // PostListing::preprocess.
  if (!empty($cached_collection_item_ids)) {
    $query->condition('collection_item.id', $cached_collection_item_ids, 'NOT IN');
  }

  // Clone this query so we can execute it without interfering with the
  // original. Plus, tag it to prevent an endless loop of this hook.
  $clone = clone $query;
  $clone->addTag('post_listing_clone');

  // Execute the clone and append the collection item ids from this query to the cache.
  $cached_collection_item_ids = array_merge($cached_collection_item_ids, $clone->execute()->fetchAllKeyed());
}

/**
 * Implements template_preprocess_node().
 *
 */
function ilr_preprocess_node__course__teaser(&$variables) {
  $variables['upcoming_classes'] = [];

  foreach ($variables['node']->classes as $upcoming_class) {
    if (!$upcoming_class->entity->field_class_cancelled->value) {
      $variables['upcoming_classes'][] = $upcoming_class->entity;
    }
  }
}

/**
 * Implements hook_token_info().
 */
function ilr_token_info() {
  $info = [];
  $info['tokens']['paragraph']['parent_entity_label'] = [
    'name' => 'Parent Entity Label',
    'description' => 'The label of the paragraph parent entity.'
  ];
  return $info;
}

/**
 * Implements hook_tokens().
 */
function ilr_tokens($type, $tokens, array $data, array $options, BubbleableMetadata $bubbleable_metadata) {
  $replacements = array();

  if ($type == 'paragraph' && !empty($data['paragraph'])) {
    $host_entity = $data['paragraph']->getParentEntity();

    foreach ($tokens as $name => $token) {
      if ($name === 'parent_entity_label') {
        $replacements[$token] = $host_entity->label();
      }
    }
  }

  return $replacements;
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function ilr_node_presave(EntityInterface $entity) {
  if ($entity->bundle() === 'certificate') {
    $certificate_total = 0;
    $certificate_topics = [];

    // Deduce the total cost and topic terms of the certificate from its courses
    // (and classes).
    foreach ($entity->field_course->referencedEntities() as $course) {
      // Since `classes` is a computed field, and it is sorted by upcoming class
      // dates, using `first()` will ensure that the next upcoming class will be
      // used for the course price.
      if ($course->classes->count()) {
        $certificate_total += $course->classes->first()->entity->field_price->value;
      }

      // Add all unique topics for each course to the topics for certificate.
      foreach ($course->field_topics->referencedEntities() as $topic) {
        if (!in_array($topic->id(), $certificate_topics)) {
          $certificate_topics[] = $topic->id();
        }
      }
    }

    $entity->set('field_total_cost', $certificate_total);
    $entity->set('field_topics', $certificate_topics);
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function ilr_taxonomy_term_presave(EntityInterface $entity) {
  // If this is a new topic, add some default page links to Certificates,
  // Programs, and Customized Programs.
  if ($entity->bundle() === 'topics' && $entity->isNew()) {
    $entity->set('field_page_links', [
      [
        'uri' => 'internal:#certificates',
        'title' => 'Certificates'
      ],
      [
        'uri' => 'internal:#programs',
        'title' => 'Programs'
      ],
      [
        'uri' => 'internal:/customized-programs',
        'title' => 'Customized Programs'
      ],
    ]);
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function ilr_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['saml_login_title'] = [
    '#markup' => '<h2>' . t('Cornell Users') . '</h2>',
    '#weight' => -3
  ];

  $form['saml_login'] = [
    '#type' => 'link',
    '#url' => Url::fromRoute('samlauth.saml_controller_login'),
    '#title' => t('NetID Login'),
    '#weight' => -2,
    '#attributes' => [
      'class' => 'cu-button'
    ],
    '#attached' => [
      'library' => [
        'union_organizer/button'
      ]
    ]
  ];

  $form['drupal_login_title'] = [
    '#markup' => '<h2>' . t('No Cornell NetID?') . '</h2>',
    '#weight' => -1
  ];
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function ilr_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add a new node add/edit form advance group section. This is generally shown
  // in the right-hand column.
  /** @see Drupal\node\NodeForm */
  $form['ilr_meta'] = [
    '#type' => 'details',
    '#title' => t('Meta'),
    '#group' => 'advanced',
    '#weight' => -10,
    '#optional' => TRUE,
    '#open' => TRUE,
  ];

  // Move the representative image and page body fields into the new section.
  $form['field_representative_image']['#group'] = 'ilr_meta';

  /** @var \Drupal\node\NodeForm $form_object */
  $form_object = $form_state->getFormObject();

  if ($form_object instanceof \Drupal\node\NodeForm) {
    $node = $form_object->getEntity();

    if ($node->bundle() === 'page' || $node->bundle() === 'story') {
      $form['body']['#group'] = 'ilr_meta';
    }

    if ($node->bundle() === 'post') {
      $form['body']['#group'] = 'ilr_meta';
      $form['field_authors']['#group'] = 'ilr_meta';
      $form['field_categories']['#group'] = 'ilr_meta';
      $form['field_published_date']['#group'] = 'ilr_meta';
      $form['author']['#title'] = t('Creation information');
      $form['uid']['widget'][0]['target_id']['#title'] = t('Created by');
      $form['created']['widget'][0]['value']['#title'] = t('Created on');
    }
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function ilr_field_widget_paragraphs_form_alter(&$element, FormStateInterface &$form_state, $context) {
  $paragraphs_entity = NULL;
  $delta = $element['#delta'];
  $field_name = $context['items']->getName();
  $widget_state = WidgetBase::getWidgetState($element['#field_parents'], $field_name, $form_state);

  // Load the paragraph entity if possible.
  /** @see \Drupal\paragraphs\Plugin\Field\FieldWidget\ParagraphsWidget::formElement() */
  if (isset($widget_state['paragraphs'][$delta]['entity'])) {
    $paragraphs_entity = $widget_state['paragraphs'][$delta]['entity'];
  }
  elseif (isset($context['items'][$delta]->entity)) {
    $paragraphs_entity = $context['items'][$delta]->entity;
  }

  // Section paragraph types should show the heading as the label if the heading
  // has a value.
  if ($paragraphs_entity && $paragraphs_entity->bundle() === 'section' && $heading = $paragraphs_entity->field_heading->value) {
    $element['top']['type']['label']['#markup'] = '<span class="paragraph-type-label">' . $heading . '</span>';
  }

  // Hide the subheading and subheading link on section paragraphs until the
  // heading has a value.
  if ($paragraphs_entity && $paragraphs_entity->bundle() === 'section' && isset($element['subform']['field_heading'])) {
    $selector = sprintf(':input[name="%s[%d][subform][field_heading][0][value]"]', $field_name, $delta);
    $element['subform']['field_subheading']['#states'] = [
      'invisible' => [
        $selector => ['value' => ''],
      ],
    ];
    $element['subform']['field_subheading_link']['#states'] = [
      'invisible' => [
        $selector => ['value' => ''],
      ],
    ];

    // Change the the subheading link field to a details element so it will be
    // collapsed by default.
    $element['subform']['field_subheading_link']['widget'][0]['#type'] = 'details';
  }

  // Move non-section paragraph behaviors below the content fields subform.
  if ($paragraphs_entity && $paragraphs_entity->bundle() !== 'section' && isset($element['behavior_plugins'])) {
    unset($element['behavior_plugins']['#weight']);
  }

  // Wrap behavior settings elements in a details container.
  if (!empty($element['behavior_plugins'])) {
    $element['behavior_plugins']['#type'] = 'details';
    $element['behavior_plugins']['#title'] = t('Settings');
  }

  // Add a class to closed paragraphs.
  $element['#attributes']['class'] = ['js-paragraph-mode--' . ($widget_state['paragraphs'][$delta]['mode'] ?? 'missing')];

  // If it's a promo, combine relevant fields in a details box for existing
  // content.
  if ($paragraphs_entity && $paragraphs_entity->bundle() === 'promo') {
    if (isset($element['subform']['field_content'])) {
      $group_selector = implode('][', array_merge($element['subform']['#parents'], ['ilr_content_wrapper']));

      $element['subform']['ilr_content_wrapper'] = [
        '#type' => 'details',
        '#title' => $element['subform']['field_content']['widget'][0]['#title'],
        '#weight' => $element['subform']['field_content']['#weight'],
        '#open' => !$paragraphs_entity->field_content->isEmpty(),
      ];

      $element['subform']['field_content']['widget'][0]['#type'] = 'container';
      $element['subform']['field_content']['#group'] = $group_selector;
      $element['subform']['field_suppress_media']['#group'] = $group_selector;
    }

    // Collapse the button (link) field if there is no value.
    if (isset($element['subform']['field_link'])) {
      $element['subform']['field_link']['widget'][0]['#type'] = 'details';
      $element['subform']['field_link']['widget'][0]['#open'] = !$paragraphs_entity->field_link->isEmpty();
    }
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function ilr_field_widget_paragraphs_previewer_form_alter(&$element, FormStateInterface &$form_state, $context) {
  ilr_field_widget_paragraphs_form_alter($element, $form_state, $context);
}

/**
 * Implements hook_user_format_name_alter().
 *
 * Display the common name, if available, as the username.
 */
function ilr_user_format_name_alter(&$name, $account) {
  if ($account instanceof \Drupal\user\Entity\User === FALSE) {
    return;
  }

  if (!$account->field_common_name->isEmpty()) {
    $name = $account->field_common_name->value;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Modify the collection new node form to add a subsite menu option.
 *
 * @see CollectionNewNodeForm::buildForm()
 */
function ilr_form_collection_new_node_form_alter(&$form, FormStateInterface $form_state) {
  /** @var \Drupal\collection\Entity\CollectionInterface $collection */
  $collection = $form_state->get('collection');

  if ($collection->bundle() === 'blog') {
    $form['bundle']['#default_value'] = 'post';
    $form['bundle']['#options'] = [
      'post' => 'Post',
      'page' => 'Page',
    ];
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function ilr_form_collection_form_alter(&$form, FormStateInterface $form_state) {
  if (isset($form['body']) || isset($form['field_representative_image'])) {
    $form['ilr_meta'] = [
      '#type' => 'details',
      '#title' => t('Meta'),
      '#group' => 'advanced',
      '#weight' => 0,
      '#optional' => TRUE,
      '#open' => TRUE,
    ];

    if (isset($form['field_representative_image'])) {
      $form['field_representative_image']['#group'] = 'ilr_meta';
    }

    if (isset($form['body'])) {
      $form['body']['#group'] = 'ilr_meta';
    }
  }

}
